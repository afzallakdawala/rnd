<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>D3 Test</title>
  <script src="d3.js"></script>
  <script src="hexbin.js"></script>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="bootstrap.min.css">
  <style>
    #arrow {
      fill: #b9b9b9;
    }
    
    .arrow {
      stroke: #b9b9b9;
      stroke-width: 2px;
    }
        
    text {
      font: 10px sans-serif;
      pointer-events: none;
    }
    #hexgon-0 {
      visibility: hidden;
    }
    

    circle {
      stroke-width: 2px;
      stroke: #fff;
    }
    .important-star-icon {
      opacity: 0.3;
      font-size: 14px;
    }
    .label-text {
      background-color: rgba(0,0,0,0.14);
      font-size: 10px;
      border-radius: 10px;
      font-weight: normal;
    }

/*    circle {
      visibility: hidden;
    }
*/    
/*    circle:first-child {
      visibility: visible;
    }
*/    
    #label-0 {
      visibility: hidden;
    }

    .display-name {
      font-size: 10px;
      text-align: center;
      color: #fff;
    }

  </style>
</head>

<body>
  <script type="text/javascript">


    var h = 700;
    var w = 1000;

var hexbin = d3.hexbin()
    .size([w, h])
    .radius(20);


    var svg = d3.select("body").append("svg").attr("width", w).attr("height", h).append("g");
var hexagon = svg.append("g")
    .attr("class", "hexagons")
    .append("path")
    .attr("d", hexbin.hexagon(19.5))
    .attr("transform", function(d) { return "translate(" + 100 + "," + 100+ ")"; })
    .style("fill", function(d) { return "orange"; });
    
    var links = [{
      source: "Concentration Terms and Concentration Solutions",
      target: "Percentage of Strength",
      important: true,
      label: "Diagram",
      color: "#9996d5"
    }, {
      source: "Concentration Terms and Concentration Solutions",
      target: "Stoichiometry",
      important: false,
      label: "Identity",
      color: "#9996d5"
    }, {
      source: "Concentration Terms and Concentration Solutions",
      target: "Stoichiometry 1",
      important: false,
      label: "Identity",
      color: "#9996d5"
    }, {
      source: "Stoichiometry 2",
      target: "Concentration Terms and Concentration Solutions",
      important: false,
      label: "Identity",
      color: "#9996d5"
    }, {
      source: "Molarity",
      target: "Concentration Terms and Concentration Solutions",
      important: true,
      label: "Defination",
      color: "#e088c5"
    }, ];
    var nodes = getNodesData();
    appendMarker();
    var force = forceLayout();
    var path = drawPath();
    var circle = drawCircle();
    drawHexagon();
    //var text = addText();
    var img = addImage();
    var important = addImportant();

    function tick() {
      path.attr("d", func);
      circle.attr("transform", transform);

      //text.attr("transform", transform);
      img.attr("x", (transform_image_x));
      img.attr("y", transform_image_y);
      important.attr("transform", transform_important);
      //labels.attr("transform" , transform_lables);
    }

    function func(d) {
      var dx = d.target.x;
      var dy = d.target.y;
      return "M" + d.source.x + "," + d.source.y + "L" + dx + "," + dy;
    }

    function transform(d, i) {
      d3.select("#hexgon-" + i).attr("transform", "translate(" + d.x + "," + d.y + ")");
      d3.select("#label-" + i).attr({
        x: d.x - 30,
        y: d.y - 37
      });
      var pos = {x: d.x - 50,y: d.y - 10}
      if (i <= 0) {
        pos = {x: d.x - 50,y: d.y - 35}
      }
      d3.select("#text-" + i).attr(pos);

      return "translate(" + d.x + "," + d.y + ")";
    }

    function transform_important(d, i) {
      var posY = d.y + 40;
      return "translate(" + d.x + "," + posY + ")";
    }

    function transform_lables(d, i) {
      var posY = d.y - 25;
      return "translate(" + d.x + "," + posY + ")";
    }

    function transform_image_x(d, i) {
      return d.x - 30;
    }

    function transform_image_y(d, i) {
      return d.y + 15;
    }

    function hexgon(index) {
      var _s32 = (Math.sqrt(3) / 2);
      var A = 55;
      var xDiff = 0;
      var yDiff = 0;
      var pointData = [
        [A + xDiff, 0 + yDiff],
        [A / 2 + xDiff, A * _s32 + yDiff],
        [-A / 2 + xDiff, A * _s32 + yDiff],
        [-A + xDiff, 0 + yDiff],
        [-A / 2 + xDiff, -A * _s32 + yDiff],
        [A / 2 + xDiff, -A * _s32 + yDiff]
      ];
      svg.append("g").selectAll("path.area") //draw elements
        .data([pointData]).enter().append("path").attr("class", "area").style("fill", force.nodes()[index].color).attr("id", "hexgon-" + index).attr("d", d3.svg.line());
    }

    function getNodesData() {
      var nodes = {};
      links.forEach(function(link) {
        link.source = nodes[link.source] || (nodes[link.source] = {
          name: link.source,
          important: link.important,
          label: link.label,
          color: link.color
        });
        link.target = nodes[link.target] || (nodes[link.target] = {
          name: link.target,
          important: link.important,
          label: link.label,
          color: link.color
        });
      });
      return nodes;
    }

    function appendMarker() {
      svg.append("defs").selectAll("marker").data(["arrow"]).enter().append("marker").attr("id", function(d) {
        return d;
      }).attr("viewBox", "0 -5 10 10").attr("refX", 66).attr("refY", 0).attr("markerWidth", 6).attr("markerHeight", 6).attr("orient", "auto").append("path").attr("d", "M0,-5L10,0L0,5");
    }

    function forceLayout() {
      return d3.layout.force().size([w, h]).nodes(d3.values(nodes)).links(links).linkDistance(w / 6).on("tick", tick).charge(function(d, i) {
        return i == 0 ? -20000 : -500;
      }).friction(0.7).gravity(0.2).start();
    }

    function drawPath() {
      return svg.append("g").selectAll("path").data(force.links()).enter().append("path").attr("class", "arrow").attr("marker-end", "url(#arrow)");
    }

    function drawCircle() {
      return svg.append("g").selectAll("path").data(force.nodes()).enter().append("circle").attr("id", function(d, i) {
        return "circle-" + i;
      }).attr("class", function(d, i) {
        return "circle-" + i;
      }).attr("r", 68)
      .attr("fill", function(d, i) {
        if (i <= 0) {
          return d.color;
        }else {
          return "#fff"
        }
      });
      
    }

    function drawHexagon() {
      for (var i = 0; i < force.nodes().length; i++) {
        hexgon(i);
        var joining_lines = d3.select("#hexgon-" + i).attr("d");
        d3.select("#hexgon-" + i).attr("d", joining_lines + " Z")
        svg.append("g").append('svg:foreignObject').attr("id", "label-" + i).attr("width", 100).attr("height", 100).html('<span class="label label-text">' + force.nodes()[i].label + '</span>');
        svg.append("g").append('svg:foreignObject').attr("id", "text-" + i).attr("width", 100).attr("height", 100).html('<div class="display-name">' + force.nodes()[i].name + '</span>');

      }
    }

    // function addText() {
    //   return svg.append("g").selectAll("text").data(force.nodes()).enter().append("text").attr("text-anchor", "middle").text(function(d, i) {
    //     return d.name;
    //   }).attr("fill", "black")
    //   ;
    // }

    function addImage() {
      return svg.append("g").selectAll("image").data(force.nodes()).enter().append("image").attr("xlink:href", "http://www4.pictures.gi.zimbio.com/Australia+South+African+Nets+Session+Press+8tEdt7zaQcql.jpg").attr("width", 25).attr("height", 25);
    }

    function addImportant() {
      return svg.append("svg:g").selectAll("text").data(force.nodes()).enter().append("text").attr("text-anchor", "middle").html(function(d, i) {
        if (d.important) {
          return "&#9733;"
        } else {
          return "";
        }
      })
      .attr("class", "important-star-icon");
      //.attr("fill", function(d) {return d.color});
    }
  </script>
</body>

</html>